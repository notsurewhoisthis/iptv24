---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '@/config';
import { deviceCategories, getDevicesByCategory, getDeviceSpecValue, type DeviceSpec } from '@/data/devices';
import { deviceComparisons } from '@/data/device-comparisons';

const entries = await getCollection('devices', ({ data }) => !data.draft);
const posts = [...entries].sort(
  (a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime()
);

const highlightKeysByCategory: Record<string, string[]> = {
  'streaming-sticks': ['maxVideo', 'wifi', 'storage'],
  'streaming-boxes': ['maxVideo', 'ethernet', 'storage'],
  'smart-tvs': ['panel', 'refresh', 'hdr'],
  'mobile-devices': ['display', 'chip', 'wifi'],
};

const getDeviceHighlights = (device: DeviceSpec) => {
  const keys = highlightKeysByCategory[device.category] || ['maxVideo', 'wifi', 'storage'];
  return keys
    .map((key) => {
      const value = getDeviceSpecValue(device, key);
      if (!value || value === '-') return null;
      return { key, value };
    })
    .filter(Boolean) as { key: string; value: string }[];
};
---

<MarketingLayout
  title={`IPTV Devices - ${siteConfig.name}`}
  description="Real device comparisons for streaming sticks, streaming boxes, smart TVs, and mobile devices used in IPTV streaming."
>
  <section class="py-section">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-bold text-text">IPTV Devices</h1>
        <p class="mt-4 text-lg text-text-muted">
          Compare streaming sticks, boxes, smart TVs, and mobile devices for IPTV playback.
        </p>
      </header>

      <div class="grid gap-6 md:grid-cols-2">
        {deviceCategories.map(({ category, label, description }) => (
          <div class="rounded-lg border border-border p-6">
            <h2 class="text-xl font-semibold text-text">{label}</h2>
            <p class="mt-2 text-sm text-text-muted">{description}</p>
            <div class="mt-4 space-y-3">
              {getDevicesByCategory(category).slice(0, 3).map((device) => (
                <a
                  class="block rounded-md border border-border p-4 hover:border-primary transition-colors"
                  href={`/devices/models/${device.slug}/`}
                >
                  <p class="font-semibold text-text">{device.name}</p>
                  <p class="text-sm text-text-muted">OS: {device.os}</p>
                  <div class="mt-3 space-y-1 text-sm text-text-muted">
                    {getDeviceHighlights(device).map((spec) => (
                      <p>{spec.value}</p>
                    ))}
                  </div>
                  {device.review && (
                    <p class="mt-3 text-sm text-text-muted">{device.review.summary}</p>
                  )}
                </a>
              ))}
            </div>
            <a class="mt-4 inline-flex text-primary hover:underline" href={`/devices/categories/${category}/`}>
              View all {label.toLowerCase()}
            </a>
          </div>
        ))}
      </div>

      <div class="mt-10 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Device comparisons</h2>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          {deviceComparisons.map((comparison) => (
            <a
              class="rounded-md border border-border p-4 hover:border-primary transition-colors"
              href={`/devices/compare/${comparison.slug}/`}
            >
              <p class="font-semibold text-text">{comparison.title}</p>
              <p class="text-sm text-text-muted">{comparison.description}</p>
            </a>
          ))}
        </div>
        <div class="mt-4 flex flex-wrap gap-4 text-sm">
          <a class="text-primary hover:underline" href="/comparisons/">Browse all comparisons</a>
          <a class="text-primary hover:underline" href="/learn/choosing-streaming-hardware/">Learn how to pick IPTV hardware</a>
          <a class="text-primary hover:underline" href="/about/">How Streaming Guide tests devices</a>
        </div>
      </div>

      <div class="space-y-8 mt-12">
        {posts.map((post) => (
          <article class="group">
            <a href={`/devices/${post.slug ?? post.id}/`} class="block">
              <div class="rounded-lg border border-border p-6 hover:border-primary transition-colors">
                <p class="text-sm text-text-muted">
                  {post.data.publishedDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </p>
                <h2 class="mt-2 text-2xl font-semibold text-text group-hover:text-primary">
                  {post.data.title}
                </h2>
                <p class="mt-3 text-text-muted">{post.data.description}</p>
              </div>
            </a>
          </article>
        ))}
      </div>

      {posts.length === 0 && (
        <div class="text-center py-12">
          <p class="text-text-muted">New device guides are coming soon.</p>
        </div>
      )}
    </div>
  </section>
</MarketingLayout>
