---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import { deviceComparisons, getDeviceComparison } from '@/data/device-comparisons';
import { getDeviceBySlug, getDeviceSpecValue } from '@/data/devices';
import { siteConfig } from '@/config';

export async function getStaticPaths() {
  return deviceComparisons.map((comparison) => ({ params: { slug: comparison.slug } }));
}

const { slug } = Astro.params as { slug: string };
const comparison = getDeviceComparison(slug);
if (!comparison) {
  throw new Error(`Comparison not found: ${slug}`);
}

const devices = comparison.deviceSlugs
  .map((deviceSlug) => getDeviceBySlug(deviceSlug))
  .filter(Boolean);
---

<MarketingLayout title={`${comparison.title} - ${siteConfig.name}`} description={comparison.description}>
  <section class="py-section">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-text">{comparison.title}</h1>
        <p class="mt-4 text-lg text-text-muted">{comparison.description}</p>
      </header>

      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="w-full text-left text-sm">
          <thead class="bg-surface text-text-muted">
            <tr>
              <th class="p-4">Spec</th>
              {devices.map((device) => (
                <th class="p-4">{device?.name}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {comparison.criteria.map((criterion) => (
              <tr class="border-t border-border">
                <td class="p-4 font-medium text-text">{criterion.label}</td>
                {devices.map((device) => (
                  <td class="p-4 text-text-muted">
                    {getDeviceSpecValue(device ?? null, criterion.key)}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div class="mt-8 grid gap-6 md:grid-cols-2">
        {devices.map((device) => (
          <div class="rounded-lg border border-border p-6">
            <h2 class="text-lg font-semibold text-text">{device?.name}</h2>
            <ul class="mt-3 space-y-2 text-sm text-text-muted">
              {device?.notes.map((note) => (
                <li>{note}</li>
              ))}
            </ul>
            <a class="mt-4 inline-flex text-primary hover:underline" href={`/devices/models/${device?.slug}/`}>
              View full device profile
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>
</MarketingLayout>
