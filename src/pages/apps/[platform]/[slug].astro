---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import EditorReview from '@/components/common/EditorReview.astro';
import {
  getAppBySlug,
  getAppHighlights,
  getAppDescriptionExcerpt,
  getAppFeatureHighlights,
  getAppSummary,
  isEditorialPick,
  getAppsByPlatform,
  slugify,
  appsUpdatedAt,
  type Platform,
} from '@/data/apps';
import { siteConfig } from '@/config';

export async function getStaticPaths() {
  const platforms = ['ios', 'macos'];
  const paths = [];
  for (const platform of platforms) {
    const apps = getAppsByPlatform(platform as Platform);
    for (const app of apps) {
      paths.push({ params: { platform, slug: slugify(app.name) } });
    }
  }
  return paths;
}

const { platform, slug } = Astro.params as { platform: Platform; slug: string };
const app = getAppBySlug(platform, slug);
if (!app) {
  throw new Error(`App not found: ${platform}/${slug}`);
}

const editorPick = isEditorialPick(app, platform);
const titleLabel = platform === 'ios' ? 'iOS IPTV App' : 'macOS IPTV App';
const description = `${app.name} details, App Store metadata, and feature highlights for ${titleLabel}.`;
const baseSeoTitle = `${app.name} ${platform === 'ios' ? 'iOS' : 'macOS'} IPTV App Review`;
const seoTitle = baseSeoTitle.length > 60 ? `${baseSeoTitle.slice(0, 57).trimEnd()}...` : baseSeoTitle;
const ratingCount = app.ratingCount ?? 0;
const excerpt = getAppDescriptionExcerpt(app);
const features = getAppFeatureHighlights(app);
const languages = app.languageCodes?.length ? app.languageCodes.join(', ') : 'Not specified';
const genres = app.genres?.length ? app.genres.join(', ') : app.primaryGenre;
const softwareAppSchema = {
  name: app.name,
  operatingSystem: platform === 'ios' ? 'iOS' : 'macOS',
  applicationCategory: 'Entertainment',
  offers: {
    '@type': 'Offer',
    price: app.price,
    priceCurrency: app.currency,
    url: app.url,
  },
  softwareVersion: app.version,
  datePublished: app.releaseDate,
  dateModified: app.currentVersionReleaseDate,
  aggregateRating:
    ratingCount > 0 && app.averageRating
      ? {
          '@type': 'AggregateRating',
          ratingValue: app.averageRating,
          ratingCount,
        }
      : undefined,
  publisher: {
    '@type': 'Organization',
    name: app.seller,
  },
  url: app.url,
};
---

<MarketingLayout
  title={`${app.name} - ${titleLabel}`}
  seoTitle={seoTitle}
  description={description}
  softwareApp={softwareAppSchema}
>
  <section class="py-section">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-8">
        <p class="text-sm uppercase tracking-[0.2em] text-text-muted">{titleLabel}</p>
        <h1 class="mt-3 text-4xl font-bold text-text">{app.name}</h1>
        <p class="mt-3 text-lg text-text-muted">{getAppSummary(app)}</p>
        {editorPick && (
          <p class="mt-3 text-sm text-primary">
            Editorial pick for {platform === 'ios' ? 'iOS' : 'macOS'} IPTV apps.
          </p>
        )}
      </header>

      <div class="rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">App Store snapshot</h2>
        <div class="mt-4 grid gap-4 sm:grid-cols-2">
          {getAppHighlights(app).map((item) => (
            <div class="rounded-md border border-border p-4 text-sm text-text-muted">{item}</div>
          ))}
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Category: {app.primaryGenre}
          </div>
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Genres: {genres}
          </div>
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Content rating: {app.contentAdvisoryRating}
          </div>
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Rating: {app.averageRating ? `${app.averageRating.toFixed(1)}` : 'No rating'} ({ratingCount.toLocaleString()} reviews)
          </div>
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Languages: {languages}
          </div>
          <div class="rounded-md border border-border p-4 text-sm text-text-muted">
            Data refreshed: {new Date(appsUpdatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
          </div>
        </div>
      </div>

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Listing summary</h2>
        {excerpt ? (
          <p class="mt-3 text-text-muted">{excerpt}</p>
        ) : (
          <p class="mt-3 text-text-muted">
            This listing does not publish a full description. Use the metadata signals below to judge app freshness.
          </p>
        )}
        <p class="mt-4 text-text-muted">
          {app.name} requires {platform === 'ios' ? 'iOS' : 'macOS'} {app.minimumOsVersion} or newer.
          The current version ({app.version}) was last updated on
          {` ${new Date(app.currentVersionReleaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`}.
        </p>
      </div>

      {features.length > 0 && (
        <div class="mt-8 rounded-lg border border-border p-6">
          <h2 class="text-xl font-semibold text-text">Feature highlights from the listing</h2>
          <ul class="mt-3 space-y-2 text-sm text-text-muted">
            {features.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        </div>
      )}

      {app.releaseNotes && (
        <div class="mt-8 rounded-lg border border-border p-6">
          <h2 class="text-xl font-semibold text-text">Latest release notes</h2>
          <p class="mt-3 text-sm text-text-muted">{app.releaseNotes}</p>
        </div>
      )}

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Compatibility and update cadence</h2>
        <p class="mt-3 text-text-muted">
          {app.name} supports {platform === 'ios' ? 'iPhone and iPad' : 'macOS'} devices and requires
          {` ${platform === 'ios' ? 'iOS' : 'macOS'} ${app.minimumOsVersion}`} or newer. The current version ({app.version}) was last updated on
          {` ${new Date(app.currentVersionReleaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`}.
        </p>
        <p class="mt-4 text-text-muted">
          We prioritize apps that show consistent App Store update activity and clear pricing. This page uses
          App Store metadata only; we do not resell IPTV services.
        </p>
      </div>

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Streaming Guide testing notes</h2>
        <ul class="mt-3 space-y-2 text-sm text-text-muted">
          <li>We check playlist import flows (M3U and Xtream Codes) and EPG load time.</li>
          <li>We track channel switching speed and stability during 30 to 60 minute viewing sessions.</li>
          <li>We log OS version and app build, then retest after major updates.</li>
        </ul>
      </div>

      {app.humanReview && (
        <div class="mt-8 rounded-lg border border-border p-6">
          <h2 class="text-xl font-semibold text-text">Editor review</h2>
          <div class="mt-4">
            <EditorReview text={app.humanReview} />
          </div>
        </div>
      )}

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Who this app fits best</h2>
        <ul class="mt-3 space-y-2 text-sm text-text-muted">
          <li>Viewers who want a current, actively updated IPTV player.</li>
          <li>Users who value stable app versions and visible App Store ratings.</li>
          <li>Anyone who needs cross-device access on {platform === 'ios' ? 'iOS' : 'macOS'}.</li>
        </ul>
      </div>

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">What to verify before you commit</h2>
        <ul class="mt-3 space-y-2 text-sm text-text-muted">
          <li>Playlist support: M3U and Xtream Codes.</li>
          <li>EPG input and time shift controls.</li>
          <li>Buffer length adjustment for live sports.</li>
          <li>Clear pricing and subscription terms.</li>
        </ul>
      </div>

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Related resources</h2>
        <ul class="mt-3 space-y-2 text-sm text-text-muted">
          <li>
            <a class="text-primary hover:underline" href={`/troubleshooting/platforms/${platform}/`}>
              {platform === 'ios' ? 'iOS' : 'macOS'} troubleshooting guides
            </a>
          </li>
          <li>
            <a class="text-primary hover:underline" href="/comparisons/">
              Compare IPTV apps and devices
            </a>
          </li>
          <li>
            <a class="text-primary hover:underline" href="/devices/categories/mobile-devices/">
              Mobile device rankings for IPTV
            </a>
          </li>
          <li>
            <a class="text-primary hover:underline" href="/guides/">
              IPTV setup and playlist guides
            </a>
          </li>
        </ul>
      </div>

      <div class="mt-8 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">Source</h2>
        <p class="mt-2 text-sm text-text-muted">
          App Store listing: <a class="text-primary hover:underline" href={app.url}>{app.url}</a>
        </p>
      </div>

      <div class="mt-8 flex flex-wrap gap-4">
        <a
          class="px-4 py-2 rounded-md bg-primary text-white text-sm font-medium hover:bg-primary-dark"
          href={app.url}
          rel="noopener"
        >
          Open in App Store
        </a>
        <a
          class="px-4 py-2 rounded-md border border-border text-sm font-medium text-text hover:border-primary"
          href={`/apps/${platform}/`}
        >
          Back to {platform === 'ios' ? 'iOS' : 'macOS'} comparisons
        </a>
      </div>
    </div>
  </section>
</MarketingLayout>
