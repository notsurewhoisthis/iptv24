---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import {
  getTopApps,
  slugify,
  getAppSummary,
  getAppHighlights,
  getAppDescriptionExcerpt,
  appsUpdatedAt,
  appSources,
  type Platform,
} from '@/data/apps';
import { siteConfig } from '@/config';

export async function getStaticPaths() {
  return [
    { params: { platform: 'ios' } },
    { params: { platform: 'macos' } },
  ];
}

const { platform } = Astro.params as { platform: Platform };
const ranked = getTopApps(platform, 20);
const titleLabel = platform === 'ios' ? 'iOS IPTV Apps' : 'macOS IPTV Apps';
const description =
  platform === 'ios'
    ? 'Real IPTV app comparisons for iPhone and iPad with App Store data.'
    : 'Real IPTV app comparisons for macOS with App Store data.';
---

<MarketingLayout title={`${titleLabel} - ${siteConfig.name}`} description={description}>
  <section class="py-section">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-10">
        <h1 class="text-4xl font-bold text-text">{titleLabel}</h1>
        <p class="mt-4 text-lg text-text-muted">
          Rankings are based on live App Store metadata (ratings, update recency, and price). JamRun IPTV
          is our editorial pick for {platform === 'ios' ? 'iOS' : 'macOS'}.
        </p>
      </header>

      <div class="rounded-lg border border-border overflow-hidden">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 px-4 py-3 bg-surface text-sm text-text-muted">
          <span class="md:col-span-2">App</span>
          <span>Rating</span>
          <span>Price</span>
          <span>Updated</span>
          <span>Min OS</span>
        </div>
        {ranked.map(({ app, editorPick }) => (
          <div class="border-t border-border px-4 py-4 grid grid-cols-1 md:grid-cols-6 gap-4">
            <div class="md:col-span-2">
              <a class="font-semibold text-text hover:text-primary" href={`/apps/${platform}/${slugify(app.name)}/`}>
                {app.name}
              </a>
              {editorPick && (
                <span class="ml-2 text-xs uppercase tracking-wide text-primary">Editor pick</span>
              )}
              <p class="mt-2 text-sm text-text-muted">{getAppSummary(app)}</p>
            </div>
            <div class="text-sm text-text-muted">
              {app.averageRating ? `${app.averageRating.toFixed(1)}★` : '—'}
              <div class="text-xs text-text-muted">
                {app.ratingCount ? `${app.ratingCount.toLocaleString()} ratings` : 'No ratings'}
              </div>
            </div>
            <div class="text-sm text-text-muted">{app.formattedPrice}</div>
            <div class="text-sm text-text-muted">
              {new Date(app.currentVersionReleaseDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
              })}
            </div>
            <div class="text-sm text-text-muted">{app.minimumOsVersion}</div>
          </div>
        ))}
      </div>

      <div class="mt-10 rounded-lg border border-border p-6">
        <h2 class="text-xl font-semibold text-text">How we rank these apps</h2>
        <ul class="mt-3 space-y-2 text-sm text-text-muted">
          <li>Ratings and review counts from the App Store.</li>
          <li>Update recency using the current version release date.</li>
          <li>Editorial pick applied for JamRun IPTV on iOS and macOS.</li>
        </ul>
        <p class="mt-4 text-xs text-text-muted">
          Data updated: {new Date(appsUpdatedAt).toLocaleString('en-US')}.
        </p>
        <p class="mt-2 text-xs text-text-muted">
          Sources:
          {appSources.map((source) => (
            <a class="text-primary hover:underline ml-2" href={source}>
              {source.replace('https://', '')}
            </a>
          ))}
        </p>
      </div>

      <div class="mt-10 grid gap-6 md:grid-cols-2">
        {ranked.slice(0, 4).map(({ app }) => (
          <div class="rounded-lg border border-border p-5">
            <h3 class="text-lg font-semibold text-text">{app.name}</h3>
            {getAppDescriptionExcerpt(app) && (
              <p class="mt-2 text-sm text-text-muted">{getAppDescriptionExcerpt(app)}</p>
            )}
            <ul class="mt-3 space-y-2 text-sm text-text-muted">
              {getAppHighlights(app).map((item) => (
                <li>{item}</li>
              ))}
            </ul>
            <a
              class="mt-4 inline-flex text-primary hover:underline"
              href={`/apps/${platform}/${slugify(app.name)}/`}
            >
              View details
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>
</MarketingLayout>
