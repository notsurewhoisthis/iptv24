---
import SEO from '@components/common/SEO.astro';
import '../styles/global.css';

interface Props {
  title: string;
  seoTitle?: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  // Article-specific props for JSON-LD
  publishedDate?: Date;
  modifiedDate?: Date;
  author?: string;
  tags?: string[];
  noindex?: boolean;
  faq?: { question: string; answer: string }[];
  howTo?: { name: string; steps: { name: string; text: string }[] };
  softwareApp?: Record<string, unknown> | null;
  person?: Record<string, unknown> | null;
  product?: Record<string, unknown> | null;
}

const {
  title,
  seoTitle,
  description,
  image,
  type = 'website',
  publishedDate,
  modifiedDate,
  author,
  tags,
  noindex,
  faq,
  howTo,
  softwareApp,
  person,
  product,
} = Astro.props;

const autoNoindexPaths = [
  '/dashboard',
  '/login',
  '/register',
  '/forgot-password',
  '/pricing',
  '/enterprise',
  '/status',
  '/customers',
  '/features',
  '/integrations',
  '/demo',
  '/docs',
  '/changelog',
  '/testimonials',
  '/roadmap',
  '/security',
  '/careers',
];

const autoNoindex = autoNoindexPaths.some((path) => Astro.url.pathname.startsWith(path));
const resolvedNoindex = typeof noindex === 'boolean' ? noindex : autoNoindex;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://play-lh.googleusercontent.com" crossorigin />
    <link rel="preconnect" href="https://is1-ssl.mzstatic.com" crossorigin />
    <link rel="preconnect" href="https://api.web3forms.com" crossorigin />
    <link rel="dns-prefetch" href="https://play-lh.googleusercontent.com" />
    <link rel="dns-prefetch" href="https://is1-ssl.mzstatic.com" />
    <link rel="dns-prefetch" href="https://api.web3forms.com" />
    <SEO
      title={title}
      seoTitle={seoTitle}
      description={description}
      image={image}
      type={type}
      publishedDate={publishedDate}
      modifiedDate={modifiedDate}
      author={author}
      tags={tags}
      noindex={resolvedNoindex}
      faq={faq}
      howTo={howTo}
      softwareApp={softwareApp}
      person={person}
      product={product}
    />
    <!-- Theme and announcement initialization - runs before page render to prevent flash -->
    <script is:inline>
      (function () {
        // Theme initialization
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }

        // Announcement dismissal check - hide if any announcement was dismissed
        const keys = Object.keys(localStorage).filter((k) =>
          k.startsWith('announcement-dismissed-')
        );
        keys.forEach((key) => {
          if (localStorage.getItem(key) === 'true') {
            const id = key.replace('announcement-dismissed-', '');
            document.documentElement.classList.add(`announcement-${id}-dismissed`);
          }
        });
      })();
    </script>
    <script type="module" is:inline>
      import { onCLS, onINP, onLCP, onFCP, onTTFB } from 'web-vitals';

      const endpoint = ${JSON.stringify(import.meta.env.PUBLIC_VITALS_ENDPOINT || '')};

      function sendToAnalytics(metric) {
        if (endpoint) {
          const body = JSON.stringify({
            name: metric.name,
            value: metric.value,
            id: metric.id,
            rating: metric.rating,
            delta: metric.delta,
            path: window.location.pathname,
          });
          const blob = new Blob([body], { type: 'application/json' });
          navigator.sendBeacon(endpoint, blob);
          return;
        }

        if (typeof window.gtag === 'function') {
          window.gtag('event', 'web_vitals', {
            event_category: 'Web Vitals',
            event_label: metric.id,
            value: Math.round(metric.value),
            metric_name: metric.name,
            metric_value: metric.value,
            metric_rating: metric.rating,
          });
        }
      }

      onCLS(sendToAnalytics);
      onINP(sendToAnalytics);
      onLCP(sendToAnalytics);
      onFCP(sendToAnalytics);
      onTTFB(sendToAnalytics);
    </script>
  </head>
  <body class="min-h-screen bg-background text-text antialiased">
    <!-- Skip to main content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-primary focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    >
      Skip to main content
    </a>
    <slot />
  </body>
</html>
